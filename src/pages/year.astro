---
import BaseHead from "@/packages/components/BaseHead.astro";
import Footer from "@/packages/components/Footer.astro";
import Header from "@/packages/header/Header.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "@/packages/consts";
import Global from "@/packages/layouts/Global.astro";
import MantineMain from "../../packages/scaffold/MantineMain";
import Folders from "../components/Folders";
import { getCounts, getHeatmapData } from "@/packages/utils/heatmap";
import { initYearPostMap } from "@/packages/utils/filter";
import { getAllPosts, mapServerPostToClient, type TClientPost } from "@/packages/utils/post";
import { SearchBanner } from "@/packages/search/Search";


const heatData = await getHeatmapData()
const counts = await getCounts()
const posts = await getAllPosts()
const yearPostMap = initYearPostMap(posts)

const yearCoverPostMap = new Map<string, TClientPost[]>()
for (const [year, postsSet] of yearPostMap) {
  const withCover =  Array.from(postsSet).filter(p => Boolean(p.data.cover))
  const top3 = await mapServerPostToClient(withCover.slice(0, 3))
  yearCoverPostMap.set(year, top3)
}
---

<Global>
  <BaseHead
    title={`${SITE_TITLE} | Archive`}
    description={SITE_DESCRIPTION}
    slot="head"
  />
  <Header/>
  <MantineMain>
    <SearchBanner client:load/>
    <Folders heatmap={heatData} counts={counts} top3s={yearCoverPostMap} client:load />
    <Footer />
  </MantineMain>
</Global>
