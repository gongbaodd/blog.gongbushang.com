---
import Global from "../../packages/layouts/Global.astro";
import BaseHead from "../../packages/components/BaseHead.astro";
import {
  SITE_DESCRIPTION,
  SITE_TITLE,
  FILTER_ENTRY,
} from "../../packages/consts";
import MantineMain from "../../packages/scaffold/MantineMain";
import BlogList, {
  BlogGrid,
  BlogGridSSR,
} from "./BlogList";
import Footer from "@/packages/components/Footer.astro";
import {
  getCategoriesFrom,
  getSeriesFrom,
  getTagsFrom,
} from "@/packages/utils/badges";
import { mapServerPostToClient } from "@/packages/utils/post";
import { MenuCategory, MenuSeries, MenuTag } from "./BlogListMenu";
import { $posts } from "../stores/posts";
import { BlogListNanoStore } from "./BlogListStore";
import { $category, $series, $tag } from "../stores/links";
import type { CollectionEntry } from "astro:content";
import PV from "./PV.astro";
import MantineHeatWrapper from "./MantineHeatWrapper.astro";
import Header from "@/packages/header/Header.astro";
type T_POST = CollectionEntry<"blog">

interface Props {
  subTitle: string;
  posts: T_POST[];
  totalCount: number;
  filter: string;
  entryType?: FILTER_ENTRY;
}

const {
  subTitle,
  posts: limitedPosts,
  filter,
  entryType,
  totalCount,
} = Astro.props;
const posts = await mapServerPostToClient(limitedPosts);
const [categories, series, tags] = await Promise.all([
  getCategoriesFrom(limitedPosts),
  getSeriesFrom(limitedPosts),
  getTagsFrom(limitedPosts),
]);

$posts.set(posts)
$category.set(categories)
$tag.set(tags)
$series.set(series)
---

<Global>
  <BaseHead
    title={`${SITE_TITLE} | ${subTitle}`}
    description={SITE_DESCRIPTION}
    slot="head"
  />
  <BlogListNanoStore
    posts={posts}
    tags={tags}
    series={series}
    categories={categories}
    filter={filter}
    entryType={entryType}
    totalCount={totalCount}
    client:load
  />
  <Header/>
  <MantineMain>
    <BlogList posts={posts}>
      <MenuCategory slot="menuCategory" client:load />
      <MenuSeries slot="menuSeries" client:load />
      <MenuTag slot="menuTag" client:load />
      <BlogGridSSR slot="blogGridxs" posts={posts} size="xs" />
      <BlogGridSSR slot="blogGridsm" posts={posts} size="sm" />
      <BlogGridSSR slot="blogGridmd" posts={posts} size="md" />
      <BlogGridSSR slot="blogGridlg" posts={posts} size="lg" />
      <BlogGridSSR slot="blogGridxl" posts={posts} size="xl" />
      <BlogGrid slot="blogGrid" client:only />
    </BlogList>
    <Footer slug={filter} />
  </MantineMain>
</Global>
