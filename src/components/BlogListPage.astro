---
import Global from "../../packages/layouts/Global.astro";
import BaseHead from "../../packages/components/BaseHead.astro";
import {
  SITE_DESCRIPTION,
  SITE_TITLE,
  FILTER_ENTRY,
} from "../../packages/consts";
import MantineMain from "../../packages/scaffold/MantineMain";
import Footer from "@/packages/components/Footer.astro";
import {
  getCategoriesFrom,
  getSeriesFrom,
  getTagsFrom,
} from "@/packages/utils/badges";
import { mapServerPostToClient } from "@/packages/utils/post";
import { BlogListMenu } from "../../packages/menu/BlogListMenu";
import { $posts, $postsListParams } from "../stores/posts";
import { BlogListNanoStore } from "./BlogListStore";
import { $category, $series, $tag } from "../stores/links";
import type { CollectionEntry } from "astro:content";
import Header from "@/packages/header/Header.astro";
import { GridWithMenu } from "@/packages/scaffold/GridWithMenu";
import BlogPlock from "../../packages/masonry/BlogPlock";
type T_POST = CollectionEntry<"blog">

interface Props {
  subTitle: string;
  posts: T_POST[];
  totalCount: number;
  filter: string;
  entryType?: FILTER_ENTRY;
}

const {
  subTitle,
  posts: limitedPosts,
  filter,
  entryType,
  totalCount,
} = Astro.props;
const posts = await mapServerPostToClient(limitedPosts);
const [categories, series, tags] = await Promise.all([
  getCategoriesFrom(limitedPosts),
  getSeriesFrom(limitedPosts),
  getTagsFrom(limitedPosts),
]);

$posts.set(posts)
$postsListParams.set({
  filter,
  entryType,
  page: 0,
  totalCount,
})
$category.set(categories)
$tag.set(tags)
$series.set(series)
---

<Global>
  <BaseHead
    title={`${SITE_TITLE} | ${subTitle}`}
    description={SITE_DESCRIPTION}
    slot="head"
  />
  <BlogListNanoStore
    posts={posts}
    tags={tags}
    series={series}
    categories={categories}
    filter={filter}
    entryType={entryType}
    totalCount={totalCount}
    client:load
  />
  <Header/>
  <MantineMain>
    <GridWithMenu menuCol={{ base: 12, md: 1.2 }} contentCol={{ base: 12, md: 10.8 }}>
      <BlogListMenu slot="menuNode" client:idle />
      <BlogPlock slot="gridContent" client:load />
    </GridWithMenu>
    <Footer slug={filter} />
  </MantineMain>
</Global>
