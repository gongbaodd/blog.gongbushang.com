---
import { getEntry, type CollectionEntry } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Footer from "../components/Footer.astro";
import Global from "./Global.astro";
import { category, excerpt, tags, title , date, series} from "../utils/extract";
import { SITE_TITLE } from "../consts";
import MantineMain from "@/src/components/MantineMain";
import BlogContent from "@/src/components/BlogContent";
import { getReadingTime } from "../utils/readingTime";
import { render } from "astro:content";
import Header from "../components/Header.astro";

type Props = CollectionEntry<"blog">;
const post = Astro.props;

const entry = await getEntry("blog", post.id)
if (!entry) {
  return Astro.redirect("/404")
}
const { headings } = await render(entry)

const postTitle = await title(post);
const postExcerpt = await excerpt(post);
const links = await getLinks();

const createDate = date(post);
const { minutes } = getReadingTime(post.body ?? "");

async function getLinks() {
  const categoryLink = category(post);
  const tagsLink = tags(post);
  const links = [categoryLink, ...tagsLink];
  const seriesLink = await series(post);
  if (seriesLink) {
    links.push(seriesLink);
  }

  return links;
}
---

<Global>
  <BaseHead
    title={`${SITE_TITLE} | ${postTitle}`}
    description={postExcerpt}
    slot="head"
  />
  <Header/>
  <MantineMain>
    <BlogContent title={postTitle} links={links} date={createDate} time={minutes + "min"} headings={headings} cover={post.data.cover}>
      <slot />
    </BlogContent>
    <Footer />
  </MantineMain>
</Global>
