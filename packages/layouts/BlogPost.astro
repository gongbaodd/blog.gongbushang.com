---
import { getEntry, type CollectionEntry } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Footer from "../footer/Footer.astro";
import Global from "./Global.astro";
import { category, excerpt, tags, title, date, series } from "../utils/extract";
import { SITE_TITLE } from "../consts";
import MantineMain from "@/packages/scaffold/MantineMain";
import BlogContent, { BlogMenu, RelatePosts } from "@/packages/content/BlogContent";
import { getReadingTime } from "../utils/readingTime";
import { render } from "astro:content";
import Header from "../header/Header.astro";
import { GridWithMenu } from "../scaffold/GridWithMenu";
import { mapServerPostToClient, type T_PROPS } from "../utils/post";

type Props = T_PROPS;
const post = Astro.props;
const [clientPost] = await mapServerPostToClient([post]);

const entry = await getEntry("blog", post.id);
if (!entry) {
  return Astro.redirect("/404");
}
const { headings } = await render(entry);

const postTitle = await title(post);
const postExcerpt = await excerpt(post);
const links = await getLinks();

const createDate = date(post);
const { minutes } = getReadingTime(post.body ?? "");

async function getLinks() {
  const categoryLink = category(post);
  const tagsLink = tags(post);
  const links = [categoryLink, ...tagsLink];
  const seriesLink = await series(post);
  if (seriesLink) {
    links.push(seriesLink);
  }

  return links;
}
---

<Global>
  <BaseHead
    title={`${SITE_TITLE} | ${postTitle}`}
    description={postExcerpt}
    slot="head"
  />
  <Header />
  <MantineMain client:load>
    <GridWithMenu menuCol={{ base: 12, lg: 2 }} contentCol={{ base: 12, lg: 10 }}>
      <BlogMenu
        post={clientPost}
        links={links}
        headings={headings}
        client:load
        slot="menuNode"
      />
      <section slot="gridContent">
        <BlogContent
          title={postTitle}
          links={links}
          date={createDate}
          time={minutes + "min"}
        >
          <slot />
        </BlogContent>
        <RelatePosts id={post.id} category={post.data.category} client:idle />
      </section>
    </GridWithMenu>
    <Footer slug={post.id} />
  </MantineMain>
</Global>
